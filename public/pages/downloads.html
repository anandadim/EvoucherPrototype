<!-- Downloads Page -->
<div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 style="margin: 0; font-size: 20px; color: #333;">ðŸ“‹ Download Records</h2>
    <div style="display: flex; gap: 10px; align-items: center;">
      <select id="sourceFilterSelect" onchange="applySourceFilter()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
        <option value="all">Semua Source</option>
      </select>
      <button onclick="exportDownloadsPage()" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
        ðŸ“¥ Export CSV
      </button>
      <button onclick="refreshDownloadsPage()" style="padding: 10px 20px; background: #9e9e9e; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
        ðŸ”„ Refresh
      </button>
    </div>
  </div>
  
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: #f5f5f5;">
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">No</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Nomor HP</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Voucher Number</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Source</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">IP Address</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Waktu Download</th>
        </tr>
      </thead>
      <tbody id="downloadsTableBody">
        <tr>
          <td colspan="6" style="padding: 40px; text-align: center; color: #999;">Loading downloads...</td>
        </tr>
      </tbody>
    </table>
    <div id="downloadsPaginationControls" style="margin-top: 20px;"></div>
  </div>
</div>

<script>
/* Pagination component (copied from admin-script.js) */
class Pagination {
  constructor(containerId, rowsPerPage = 20) {
    this.containerId = containerId;
    this.rowsPerPage = rowsPerPage;
    this.currentPage = 1;
    this.allData = [];
    this.renderCallback = null;
  }
  setData(data, renderCallback) {
    this.allData = data;
    this.renderCallback = renderCallback;
    this.currentPage = 1;
    this.render();
  }
  render() {
    if (!this.renderCallback) return;
    const startIndex = (this.currentPage - 1) * this.rowsPerPage;
    const endIndex = startIndex + this.rowsPerPage;
    const pageData = this.allData.slice(startIndex, endIndex);
    this.renderCallback(pageData, startIndex);
    this.renderControls();
  }
  renderControls() {
    const container = document.getElementById(this.containerId);
    if (!container) return;
    const totalPages = Math.ceil(this.allData.length / this.rowsPerPage);
    const startRecord = this.allData.length === 0 ? 0 : (this.currentPage - 1) * this.rowsPerPage + 1;
    const endRecord = Math.min(this.currentPage * this.rowsPerPage, this.allData.length);
    container.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:15px;background:#f5f5f5;border-radius:8px;">
        <div style="color:#666;font-size:14px;">
          ${startRecord}-${endRecord} of ${this.allData.length} | Page ${this.currentPage} of ${totalPages}
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="btn-page" data-action="first" ${this.currentPage===1?'disabled':''}>First</button>
          <button class="btn-page" data-action="prev" ${this.currentPage===1?'disabled':''}>â—€</button>
          <div style="display:flex;gap:5px;">${this.renderPageNumbers(totalPages)}</div>
          <button class="btn-page" data-action="next" ${this.currentPage===totalPages||totalPages===0?'disabled':''}>â–¶</button>
          <button class="btn-page" data-action="last" ${this.currentPage===totalPages||totalPages===0?'disabled':''}>Last</button>
          <div style="display:flex;gap:5px;align-items:center;margin-left:10px;">
            <input type="number" class="page-input" min="1" max="${totalPages}" value="${this.currentPage}" style="width:50px;padding:6px;border:1px solid #ddd;border-radius:4px;text-align:center;">
            <button class="btn-page" data-action="go">Go</button>
          </div>
        </div>
      </div>`;
    this.attachEventListeners(totalPages);
  }
  renderPageNumbers(totalPages){
     let html='';
     if(totalPages<=5){
        for(let i=1;i<=totalPages;i++){html+=this.createPageButton(i);}  
     }else{
       if(this.currentPage<=3){
         for(let i=1;i<=4;i++){html+=this.createPageButton(i);}  
         html+='<span style="padding:6px;">...</span>';
         html+=this.createPageButton(totalPages);
       }else if(this.currentPage>=totalPages-2){
         html+=this.createPageButton(1);
         html+='<span style="padding:6px;">...</span>';
         for(let i=totalPages-3;i<=totalPages;i++){html+=this.createPageButton(i);}  
       }else{
         html+=this.createPageButton(1);
         html+='<span style="padding:6px;">...</span>';
         for(let i=this.currentPage-1;i<=this.currentPage+1;i++){html+=this.createPageButton(i);}  
         html+='<span style="padding:6px;">...</span>';
         html+=this.createPageButton(totalPages);
       }
     }
     return html;
  }
  createPageButton(pageNum){
     const isActive=pageNum===this.currentPage;
     return `<button class="btn-page-num" data-page="${pageNum}" style="padding:6px 10px;border:1px solid ${isActive?'#667eea':'#ddd'};background:${isActive?'#667eea':'white'};color:${isActive?'white':'#333'};border-radius:4px;cursor:pointer;font-size:13px;font-weight:${isActive?'600':'normal'};">${pageNum}</button>`;
  }
  attachEventListeners(totalPages){
    const container=document.getElementById(this.containerId);
    if(!container) return;
    container.querySelectorAll('.btn-page').forEach(btn=>{
       btn.addEventListener('click',e=>{
         const action=e.target.dataset.action;
         switch(action){
           case 'first': this.goToPage(1); break;
           case 'prev': this.goToPage(this.currentPage-1); break;
           case 'next': this.goToPage(this.currentPage+1); break;
           case 'last': this.goToPage(totalPages); break;
           case 'go':
             const input=container.querySelector('.page-input');
             const page=parseInt(input.value);
             this.goToPage(page);
             break;
         }
       });
    });
    container.querySelectorAll('.btn-page-num').forEach(btn=>{
        btn.addEventListener('click',e=>{
            const page=parseInt(e.target.dataset.page);
            this.goToPage(page);
        });
    });
    const input=container.querySelector('.page-input');
    if(input){
      input.addEventListener('keypress',e=>{
        if(e.key==='Enter'){
           const page=parseInt(e.target.value);
           this.goToPage(page);
        }
      });
    }
  }
  goToPage(page){
    const totalPages=Math.ceil(this.allData.length/this.rowsPerPage);
    if(page<1||page>totalPages||isNaN(page)) return;
    this.currentPage=page;
    this.render();
  }
}

/* End Pagination component */

// ============================
// Filter by Source
// ============================
let allDownloadsData = [];

function populateSourceFilter(data){
  const select = document.getElementById('sourceFilterSelect');
  if(!select){return;}
  const uniqueSources = [...new Set(data.map(d => (d.utm_source || 'direct')))].sort();
  select.innerHTML = '<option value="all">Semua Source</option>' +
    uniqueSources.map(s => `<option value="${s}">${s}</option>`).join('');
}

function applySourceFilter(){
  const select = document.getElementById('sourceFilterSelect');
  if(!select){return;}
  const selected = select.value;
  const filtered = selected === 'all'
    ? allDownloadsData
    : allDownloadsData.filter(d => (d.utm_source || 'direct') === selected);
  downloadsPagination.setData(filtered, window.renderDownloadsTable);
}


async function loadDownloadsPage() {
  try {
    const response = await fetch('/api/admin/stats');
    const data = await response.json();
    const tbody = document.getElementById('downloadsTableBody');
    if (!data.downloads || data.downloads.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #999;">Belum ada data download</td></tr>';
      document.getElementById('downloadsPaginationControls').innerHTML = '';
      return;
    }

    // Store data and setup filter & pagination
    allDownloadsData = data.downloads;
    populateSourceFilter(allDownloadsData);
    downloadsPagination.setData(allDownloadsData, renderDownloadsTable);

    function renderDownloadsTable(pageData, startIndex){
       if(pageData.length===0){
         tbody.innerHTML='<tr><td colspan="6" style="padding: 40px; text-align: center; color: #999;">Belum ada data download</td></tr>';
         return;
       }
       tbody.innerHTML = pageData.map((row, idx) => {
          const utmBadge = row.utm_source === 'direct'
            ? '<span style="background: #9e9e9e; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Direct</span>'
            : `<span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${row.utm_source || 'direct'}</span>`;
          return `
            <tr>
              <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${startIndex + idx + 1}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${row.phone_number}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;"><span style="font-family: monospace; background: #f5f5f5; padding: 4px 8px; border-radius: 4px;">${row.voucher_number || 'N/A'}</span></td>
              <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${utmBadge}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${row.ip_address}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${new Date(row.download_time).toLocaleString('id-ID')}</td>
            </tr>`;
       }).join('');
    }

  } catch (error) {
    console.error('Error loading downloads:', error);
    document.getElementById('downloadsTableBody').innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #f44336;">Error loading data</td></tr>';
  }
}

function exportDownloadsPage() {
  window.location.href = '/api/admin/export-csv';
}

function refreshDownloadsPage() {
  loadDownloadsPage();
}

const downloadsPagination = new Pagination('downloadsPaginationControls', 20);

// initial load
loadDownloadsPage();
</script>
  <!-- try {
    const response = await fetch('/api/admin/stats');
    const data = await response.json();
    
    const tbody = document.getElementById('downloadsTableBody');
    
    if (!data.downloads || data.downloads.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #999;">Belum ada data download</td></tr>';
      return;
    }

    tbody.innerHTML = data.downloads.map((row, index) => {
      const utmBadge = row.utm_source === 'direct' 
        ? '<span style="background: #9e9e9e; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Direct</span>'
        : `<span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${row.utm_source || 'direct'}</span>`;
      
      return `
        <tr>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${index + 1}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${row.phone_number}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;"><span style="font-family: monospace; background: #f5f5f5; padding: 4px 8px; border-radius: 4px;">${row.voucher_number || 'N/A'}</span></td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${utmBadge}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${row.ip_address}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${new Date(row.download_time).toLocaleString('id-ID')}</td>
        </tr>
      `;
    }).join('');
  } catch (error) {
    console.error('Error loading downloads:', error);
    document.getElementById('downloadsTableBody').innerHTML = 
      '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #f44336;">Error loading data</td></tr>';
  }
}

function exportDownloadsPage() {
  window.location.href = '/api/admin/export-csv';
}

function refreshDownloadsPage() {
  loadDownloadsPage();
}

loadDownloadsPage();
</script> -->
