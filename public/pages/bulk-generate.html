<!-- Bulk Generate Page -->
<div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px;">
  <h2 style="margin: 0 0 15px 0; font-size: 20px; color: #333;">üñºÔ∏è Generate Voucher Images (Bulk)</h2>
  <p style="color: #666; margin-bottom: 20px;">Upload file CSV untuk generate voucher images secara massal</p>
  
  <!-- Download Template -->
  <div style="margin-bottom: 25px; padding: 20px; background: #f5f5f5; border-radius: 8px;">
    <a href="/api/admin/download-csv-template" download style="display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 14px;">
      <span style="font-size: 20px;">üì•</span>
      Download Template CSV
    </a>
    <span style="margin-left: 15px; color: #666; font-size: 13px;">
      ‚ÑπÔ∏è Template berisi format yang benar dengan contoh data
    </span>
  </div>

  <!-- Upload CSV -->
  <div style="margin-bottom: 20px;">
    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #666; font-weight: 500;">Upload File CSV</label>
    <input type="file" id="bulkCsvFileInput" accept=".csv" style="padding: 10px; border: 2px dashed #e0e0e0; border-radius: 8px; cursor: pointer; width: 100%;">
    <span style="display: block; margin-top: 8px; font-size: 13px; color: #999;">Format: Nama Customer, No Handphone, Tanggal Blasting, Kode Voucher SRP</span>
  </div>

  <!-- Template Selection -->
  <div style="margin-bottom: 20px;">
    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #666; font-weight: 500;">Pilih Template Cabang</label>
    <select id="templateSelect" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; width: 100%; cursor: pointer;">
      <option value="voucher-template.jpeg">Default Template</option>
      <option value="voucher-template-cibinong.jpg">Cabang Cibinong</option>
      <option value="voucher-template-cileungsi.jpg">Cabang Cileungsi</option>
    </select>
    <span style="display: block; margin-top: 8px; font-size: 13px; color: #999;">Pilih template sesuai cabang untuk generate voucher</span>

    <!-- Include QR checkbox -->
    <div style="margin-top: 15px;">
      <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #666; font-weight: 500;">
        <input type="checkbox" id="includeQrCheckbox" checked>
        Tambahkan QR Code ke Voucher
      </label>
    </div>
  </div>

  <!-- Generate Button -->
  <button id="generateBulkBtn" disabled style="padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
    üñºÔ∏è Generate Images
  </button>

  <!-- Progress Bar -->
  <div id="bulkProgress" style="display: none; margin-top: 25px;">
    <div style="background: #f5f5f5; border-radius: 8px; padding: 20px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <span style="font-weight: 600; color: #333;">Processing...</span>
        <span id="bulkProgressText" style="font-weight: 600; color: #667eea;">0%</span>
      </div>
      <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
        <div id="bulkProgressBar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Batch History -->
<div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
  <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #333;">üì¶ Batch History</h2>
  
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: #f5f5f5;">
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #333;">Batch ID</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #333;">Tanggal</th>
          <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #333;">Total</th>
          <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #333;">Berhasil</th>
          <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #333;">Error</th>
          <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #333;">Images</th>
          <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #333;">Actions</th>
        </tr>
      </thead>
      <tbody id="batchHistoryTableBody">
        <tr>
          <td colspan="7" style="padding: 40px; text-align: center; color: #999;">Loading batch history...</td>
        </tr>
      </tbody>
    </table>
    <div id="bulkPaginationControls" style="margin-top: 20px;"></div>
  </div>
</div>

<script>
// Enable/disable generate button
document.getElementById('bulkCsvFileInput').addEventListener('change', (e) => {
  document.getElementById('generateBulkBtn').disabled = !e.target.files.length;
});

// Generate bulk voucher images
document.getElementById('generateBulkBtn').addEventListener('click', async () => {
  const fileInput = document.getElementById('bulkCsvFileInput');
  const templateSelect = document.getElementById('templateSelect');
  const generateBtn = document.getElementById('generateBulkBtn');
  const progressDiv = document.getElementById('bulkProgress');
  const progressBar = document.getElementById('bulkProgressBar');
  const progressText = document.getElementById('bulkProgressText');

  if (!fileInput.files.length) {
    alert('Pilih file CSV terlebih dahulu');
    return;
  }

  const file = fileInput.files[0];
  const selectedTemplate = templateSelect.value;
  const includeQR = document.getElementById('includeQrCheckbox').checked;
  
  const formData = new FormData();
  formData.append('csvFile', file);
  formData.append('template', selectedTemplate);
  formData.append('includeQR', includeQR);

  try {
    generateBtn.disabled = true;
    generateBtn.textContent = 'Processing...';
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = '0%';

    // Simulate progress
    let progress = 0;
    const progressInterval = setInterval(() => {
      if (progress < 90) {
        progress += 10;
        progressBar.style.width = progress + '%';
        progressText.textContent = progress + '%';
      }
    }, 500);

    const response = await fetch('/api/admin/generate-voucher-batch', {
      method: 'POST',
      body: formData
    });

    clearInterval(progressInterval);
    progressBar.style.width = '100%';
    progressText.textContent = '100%';

    const data = await response.json();

    if (response.ok) {
      setTimeout(() => {
        alert(`‚úì Berhasil generate ${data.successCount} voucher images!\n\nTotal: ${data.totalRows}\nBerhasil: ${data.successCount}\nError: ${data.errorCount}\n\nBatch ID: ${data.batchId}`);
        
        fileInput.value = '';
        generateBtn.disabled = true;
        progressDiv.style.display = 'none';
        
        // Reload batch history
        loadBatchHistoryPage();
      }, 500);
    } else {
      alert('Error: ' + (data.error || 'Failed to generate vouchers'));
      progressDiv.style.display = 'none';
    }
  } catch (error) {
    alert('Error: ' + error.message);
    progressDiv.style.display = 'none';
  } finally {
    generateBtn.disabled = false;
    generateBtn.textContent = 'üñºÔ∏è Generate Images';
  }
});

/* Pagination component (copied from admin-script.js) */
class Pagination {
  constructor(containerId, rowsPerPage = 10) {
    this.containerId = containerId;
    this.rowsPerPage = rowsPerPage;
    this.currentPage = 1;
    this.allData = [];
    this.renderCallback = null;
  }
  setData(data, renderCallback) {
    this.allData = data;
    this.renderCallback = renderCallback;
    this.currentPage = 1;
    this.render();
  }
  render() {
    if (!this.renderCallback) return;
    const startIndex = (this.currentPage - 1) * this.rowsPerPage;
    const endIndex = startIndex + this.rowsPerPage;
    const pageData = this.allData.slice(startIndex, endIndex);
    this.renderCallback(pageData, startIndex);
    this.renderControls();
  }
  renderControls() {
    const container = document.getElementById(this.containerId);
    if (!container) return;
    const totalPages = Math.ceil(this.allData.length / this.rowsPerPage);
    const startRecord = this.allData.length === 0 ? 0 : (this.currentPage - 1) * this.rowsPerPage + 1;
    const endRecord = Math.min(this.currentPage * this.rowsPerPage, this.allData.length);
    container.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:15px;background:#f5f5f5;border-radius:8px;">
        <div style="color:#666;font-size:14px;">
          ${startRecord}-${endRecord} of ${this.allData.length} | Page ${this.currentPage} of ${totalPages}
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="btn-page" data-action="first" ${this.currentPage===1?'disabled':''}>First</button>
          <button class="btn-page" data-action="prev" ${this.currentPage===1?'disabled':''}>‚óÄ</button>
          <div style="display:flex;gap:5px;">${this.renderPageNumbers(totalPages)}</div>
          <button class="btn-page" data-action="next" ${this.currentPage===totalPages||totalPages===0?'disabled':''}>‚ñ∂</button>
          <button class="btn-page" data-action="last" ${this.currentPage===totalPages||totalPages===0?'disabled':''}>Last</button>
          <div style="display:flex;gap:5px;align-items:center;margin-left:10px;">
            <input type="number" class="page-input" min="1" max="${totalPages}" value="${this.currentPage}" style="width:50px;padding:6px;border:1px solid #ddd;border-radius:4px;text-align:center;">
            <button class="btn-page" data-action="go">Go</button>
          </div>
        </div>
      </div>`;
    this.attachEventListeners(totalPages);
  }
  renderPageNumbers(totalPages){
     let html='';
     if(totalPages<=5){
        for(let i=1;i<=totalPages;i++){html+=this.createPageButton(i);}  
     }else{
       if(this.currentPage<=3){
         for(let i=1;i<=4;i++){html+=this.createPageButton(i);}  
         html+='<span style="padding:6px;">...</span>';
         html+=this.createPageButton(totalPages);
       }else if(this.currentPage>=totalPages-2){
         html+=this.createPageButton(1);
         html+='<span style="padding:6px;">...</span>';
         for(let i=totalPages-3;i<=totalPages;i++){html+=this.createPageButton(i);}  
       }else{
         html+=this.createPageButton(1);
         html+='<span style="padding:6px;">...</span>';
         for(let i=this.currentPage-1;i<=this.currentPage+1;i++){html+=this.createPageButton(i);}  
         html+='<span style="padding:6px;">...</span>';
         html+=this.createPageButton(totalPages);
       }
     }
     return html;
  }
  createPageButton(pageNum){
     const isActive=pageNum===this.currentPage;
     return `<button class="btn-page-num" data-page="${pageNum}" style="padding:6px 10px;border:1px solid ${isActive?'#667eea':'#ddd'};background:${isActive?'#667eea':'white'};color:${isActive?'white':'#333'};border-radius:4px;cursor:pointer;font-size:13px;font-weight:${isActive?'600':'normal'};">${pageNum}</button>`;
  }
  attachEventListeners(totalPages){
    const container=document.getElementById(this.containerId);
    if(!container) return;
    container.querySelectorAll('.btn-page').forEach(btn=>{
       btn.addEventListener('click',e=>{
         const action=e.target.dataset.action;
         switch(action){
           case 'first': this.goToPage(1); break;
           case 'prev': this.goToPage(this.currentPage-1); break;
           case 'next': this.goToPage(this.currentPage+1); break;
           case 'last': this.goToPage(totalPages); break;
           case 'go':
             const input=container.querySelector('.page-input');
             const page=parseInt(input.value);
             this.goToPage(page);
             break;
         }
       });
    });
    container.querySelectorAll('.btn-page-num').forEach(btn=>{
        btn.addEventListener('click',e=>{
            const page=parseInt(e.target.dataset.page);
            this.goToPage(page);
        });
    });
    const input=container.querySelector('.page-input');
    if(input){
      input.addEventListener('keypress',e=>{
        if(e.key==='Enter'){
           const page=parseInt(e.target.value);
           this.goToPage(page);
        }
      });
    }
  }
  goToPage(page){
    const totalPages=Math.ceil(this.allData.length/this.rowsPerPage);
    if(page<1||page>totalPages||isNaN(page)) return;
    this.currentPage=page;
    this.render();
  }
}

/* End Pagination component */


// Load batch history
async function loadBatchHistoryPage() {
  try {
    const response = await fetch('/api/admin/voucher-batches');
    const data = await response.json();

    const tbody = document.getElementById('batchHistoryTableBody');
    
    if (!data.batches || data.batches.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: #999;">Belum ada batch</td></tr>';
      document.getElementById('bulkPaginationControls').innerHTML = '';
      return;
    }


    // Setup pagination with fetched batch data
    bulkPagination.setData(data.batches, renderBatchesTable);
        // Expose render function so filter can reuse it
    window.renderBatchesTable = renderBatchesTable;


    function renderBatchesTable(pageData, startIndex){
       if(pageData.length===0){
         tbody.innerHTML='<tr><td colspan="6" style="padding: 40px; text-align: center; color: #999;">Belum ada data download</td></tr>';
         return;
       }
    tbody.innerHTML = pageData.map((batch, idx) => {
      const date = new Date(batch.createdAt);
      const formattedDate = date.toLocaleString('id-ID', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      return `
        <tr>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; font-family: monospace; font-size: 12px;">${batch.batchId}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${formattedDate}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; text-align: center;">${batch.totalRows}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; text-align: center; color: #4caf50; font-weight: 600;">${batch.successCount}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; text-align: center; color: #f44336; font-weight: 600;">${batch.errorCount}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; text-align: center;">${batch.imageCount} images</td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; text-align: center;">
            <button onclick="downloadBatchPage('${batch.batchId}')" style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; margin-right: 5px;">
              üì• Download
            </button>
          </td>
        </tr>
      `;
    }).join('');
  }
  } catch (error) {
    console.error('Error loading batch history:', error);
    document.getElementById('batchHistoryTableBody').innerHTML = 
      '<tr><td colspan="7" style="padding: 40px; text-align: center; color: #f44336;">Error loading batches</td></tr>';
  }
}

// Download batch
async function downloadBatchPage(batchId) {
  try {
    const response = await fetch(`/api/admin/download-batch/${batchId}`);
    
    if (response.ok) {
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${batchId}.zip`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    } else {
      const data = await response.json();
      alert('Error: ' + (data.error || 'Failed to download batch'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

const bulkPagination = new Pagination('bulkPaginationControls', 10);

// dloadBulkPage = loadBulkPage;
// initial load
loadBatchHistoryPage();

// Load batch history on page load
// loadBatchHistoryPage();
</script>
